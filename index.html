<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Metro Dashboard - DataForce</title>
  <link rel="stylesheet" href="style.css">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
</head>

<body>
  <header class="header">
    <div class="logo-area">
      <img src="logo.png" class="logo" alt="DataForce Logo">
      <h1 class="title">Metro System Dashboard</h1>
    </div>

    <nav class="nav">
      <a href="topup.html" class="btn">Nạp tiền</a>
      <a href="cards.html" class="btn blue">Quản lý thẻ</a>
      <a href="stations.html" class="btn cyan">Ga</a>
    </nav>
  </header>

  <main class="container">

    <div class="card">

      <div class="controls">
        <input id="filterUid" class="input" placeholder="Lọc theo UID" />
        <select id="filterStatus" class="input">
          <option value="">Tất cả trạng thái</option>
          <option value="success">SUCCESS</option>
          <option value="error">ERROR</option>
        </select>
        <button id="refresh" class="btn">Làm mới</button>
      </div>

      <div class="table-responsive card">
        <table id="logsTable">
          <thead>
            <tr>
              <th>UID</th>
              <th>Ga vào</th>
              <th>Thời gian</th>
              <th>Fare</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="footer small">Realtime từ Firebase Realtime Database</div>
    </div>

    <aside class="sidebar">
      <div class="card sidebar-card">
        <h3>Thông tin hệ thống</h3>
        <div class="section small">
          <div>Tổng giao dịch: <span id="txCount">0</span></div>
          <div>Tổng tiền thu: <span id="totalFare">0</span> VND</div>
        </div>
      </div>

      <div class="card sidebar-card">
        <h3>Hướng dẫn nhanh</h3>
        <div class="small">
          - "Nạp tiền": thay đổi số dư thẻ.<br/>
          - ESP8266 push mỗi giao dịch vào /metro/transactions.
        </div>
      </div>
    </aside>

  </main>

  <script>
  const firebaseConfig = {
    databaseURL: "https://metrosystem-c3170-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tbody = document.querySelector('#logsTable tbody');
  const txCountEl = document.getElementById('txCount');
  const totalFareEl = document.getElementById('totalFare');
  const filterUid = document.getElementById('filterUid');
  const filterStatus = document.getElementById('filterStatus');
  const refreshBtn = document.getElementById('refresh');

  function formatTime(ts){
    if (!ts) return "";
    return new Date(ts * 1000).toLocaleString();
  }

  function renderRows(data){
    tbody.innerHTML = '';
    if (!data) return;

    const keys = Object.keys(data).sort((a,b) =>
      (data[b].timestamp || 0) - (data[a].timestamp || 0)
    );

    keys.forEach(k => {
      const item = data[k];

      if (filterUid.value && !String(item.uid).includes(filterUid.value)) return;
      if (filterStatus.value && item.result !== filterStatus.value) return;

      const badgeClass = item.result === "success" ? "success" : "fail";

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.uid || ''}</td>
        <td>${item.station_in || ''}</td>
        <td>${formatTime(item.timestamp)}</td>
        <td>${item.fare || 0}</td>
        <td><span class="badge ${badgeClass}">${item.result}</span></td>
      `;
      tbody.appendChild(tr);
    });
  }

  db.ref("metro/transactions").on("value", snap => {
    const data = snap.val();
    renderRows(data);

    let tx = 0, money = 0;
    if (data) {
      Object.values(data).forEach(it => {
        tx++;
        money += Number(it.fare || 0);
      });
    }

    txCountEl.textContent = tx;
    totalFareEl.textContent = money;
  });

  refreshBtn.addEventListener("click", () => {
    db.ref("metro/transactions")
      .once("value")
      .then(s => renderRows(s.val()));
  });

    // === THÊM PHẦN NÀY ĐỂ TỰ ĐỘNG TẠO THẺ NẾU UID CHƯA TỒN TẠI ===
  
  const cardsRef = db.ref("metro/cards");

  function ensureCardExists(uid) {
    if (!uid) return;

    cardsRef.child(uid).once("value", snap => {
      if (!snap.exists()) {
        cardsRef.child(uid).set({
          balance: 0,
          created_at: Date.now(),
          active: true
        });
        console.log(">> Đã tạo thẻ mới trong Firebase:", uid);
      }
    });
  }

  // Lắng nghe mọi giao dịch mới → tự động thêm thẻ nếu chưa có
  db.ref("metro/transactions").on("child_added", snap => {
    const item = snap.val();
    if (item && item.uid) ensureCardExists(item.uid);
  });
  </script>

</body>
</html>
